<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 인증 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 5px;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 3px;
            background-color: #f8f9fa;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>🎓 EveryCourse 학생 인증 테스트</h1>
    
    <!-- 0. 사용자 생성 섹션 (NEW!) -->
    <div class="section" style="background-color: #fff3cd;">
        <h2>0️⃣ 테스트 사용자 생성</h2>
        <p><strong>먼저 테스트할 사용자를 생성하세요!</strong> (이 단계가 createUserProfile 트리거를 실행합니다)</p>
        <input type="text" id="newUserId" placeholder="사용자 ID (예: test-user-1)" style="width: 200px;">
        <input type="email" id="newUserEmail" placeholder="기본 이메일 (예: user@gmail.com)" style="width: 250px;">
        <input type="text" id="newUserName" placeholder="이름 (예: 홍길동)" style="width: 150px;">
        <button onclick="createTestUser()" style="background-color: #28a745;">사용자 생성</button>
        <div id="result0" class="result" style="display: none;"></div>
    </div>
    
    <!-- 1. 학생 인증 신청 섹션 -->
    <div class="section">
        <h2>1️⃣ 학생 인증 신청</h2>
        <p>대학교 이메일로 학생 인증을 신청합니다.</p>
        <input type="text" id="userId1" placeholder="사용자 ID (예: user123)" style="width: 200px;">
        <input type="email" id="universityEmail" placeholder="대학교 이메일 (예: student@snu.ac.kr)" style="width: 250px;">
        <button onclick="requestVerification()">인증 신청</button>
        <div id="result1" class="result" style="display: none;"></div>
    </div>

    <!-- 2. 이메일 인증 완료 섹션 -->
    <div class="section">
        <h2>2️⃣ 이메일 인증 완료</h2>
        <p>이메일로 받은 인증 토큰을 입력합니다.</p>
        <input type="text" id="userId2" placeholder="사용자 ID" style="width: 200px;">
        <input type="text" id="verificationToken" placeholder="인증 토큰" style="width: 250px;">
        <button onclick="verifyEmail()">인증 완료</button>
        <div id="result2" class="result" style="display: none;"></div>
    </div>

    <!-- 3. 학생 상태 확인 섹션 -->
    <div class="section">
        <h2>3️⃣ 학생 상태 확인</h2>
        <p>현재 학생 인증 상태를 확인합니다.</p>
        <input type="text" id="userId3" placeholder="사용자 ID" style="width: 200px;">
        <button onclick="checkStatus()">상태 확인</button>
        <div id="result3" class="result" style="display: none;"></div>
    </div>

    <!-- 테스트 가이드 -->
    <div class="section" style="background-color: #f0f8ff;">
        <h2>📋 테스트 가이드</h2>
        <ol>
            <li><strong>유효한 대학교 이메일 형식:</strong>
                <ul>
                    <li>@snu.ac.kr (서울대)</li>
                    <li>@yonsei.ac.kr (연세대)</li>
                    <li>@korea.ac.kr (고려대)</li>
                    <li>@kaist.ac.kr (카이스트)</li>
                    <li>또는 .ac.kr, .edu.kr, .edu로 끝나는 이메일</li>
                </ul>
            </li>
            <li><strong>테스트 순서:</strong> 사용자 생성 → 인증 신청 → 토큰 입력 → 상태 확인</li>
            <li><strong>참고:</strong> 실제 이메일 발송은 구현되지 않았으므로, 토큰은 개발자 도구에서 확인하거나 Firebase 콘솔에서 확인하세요.</li>
        </ol>
    </div>

    <script>
        const API_BASE_URL = 'https://us-central1-everycourse-911af.cloudfunctions.net';

        async function createTestUser() {
            const userId = document.getElementById('newUserId').value;
            const email = document.getElementById('newUserEmail').value;
            const displayName = document.getElementById('newUserName').value;
            const resultDiv = document.getElementById('result0');

            if (!userId || !email || !displayName) {
                showResult(resultDiv, '모든 필드를 입력해주세요.', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/createTestUser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId, email, displayName })
                });

                const result = await response.json();
                showResult(resultDiv, result.message, result.success);

                // 성공하면 다른 필드들도 자동으로 채움
                if (result.success) {
                    document.getElementById('userId1').value = userId;
                    document.getElementById('userId2').value = userId;
                    document.getElementById('userId3').value = userId;
                }

            } catch (error) {
                showResult(resultDiv, `오류: ${error.message}`, false);
            }
        }

        async function requestVerification() {
            const userId = document.getElementById('userId1').value;
            const universityEmail = document.getElementById('universityEmail').value;
            const resultDiv = document.getElementById('result1');

            if (!userId || !universityEmail) {
                showResult(resultDiv, '사용자 ID와 대학교 이메일을 모두 입력해주세요.', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/requestStudentVerification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId, universityEmail })
                });

                const result = await response.json();
                showResult(resultDiv, result.message, result.success);

            } catch (error) {
                showResult(resultDiv, `오류: ${error.message}`, false);
            }
        }

        async function verifyEmail() {
            const userId = document.getElementById('userId2').value;
            const token = document.getElementById('verificationToken').value;
            const resultDiv = document.getElementById('result2');

            if (!userId || !token) {
                showResult(resultDiv, '사용자 ID와 인증 토큰을 모두 입력해주세요.', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/verifyStudentEmail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId, token })
                });

                const result = await response.json();
                showResult(resultDiv, result.message, result.success);

            } catch (error) {
                showResult(resultDiv, `오류: ${error.message}`, false);
            }
        }

        async function checkStatus() {
            const userId = document.getElementById('userId3').value;
            const resultDiv = document.getElementById('result3');

            if (!userId) {
                showResult(resultDiv, '사용자 ID를 입력해주세요.', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/checkStudentStatus?userId=${encodeURIComponent(userId)}`);
                const result = await response.json();

                if (result.success) {
                    const message = result.isStudent 
                        ? '✅ 학생 인증이 완료된 사용자입니다!' 
                        : '❌ 아직 학생 인증이 완료되지 않았습니다.';
                    showResult(resultDiv, message, true);
                } else {
                    showResult(resultDiv, result.message, false);
                }

            } catch (error) {
                showResult(resultDiv, `오류: ${error.message}`, false);
            }
        }

        function showResult(element, message, isSuccess) {
            element.textContent = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>
